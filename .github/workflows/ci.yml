name: CI

on:
  pull_request:
    branches: [main]

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ['3.10', '3.11', '3.12', '3.13']
    steps:
      - uses: actions/checkout@v4

      - name: Install uv from .github/download-utilities.yml
        run: |
          YML_INSTALL_FILES_VERSION="v3.8"
          curl -fsSL -o download-utilities.sh "https://raw.githubusercontent.com/samrocketman/yml-install-files/${YML_INSTALL_FILES_VERSION}/download-utilities.sh"
          chmod +x download-utilities.sh
          ./download-utilities.sh .github/download-utilities.yml uv
          echo "/usr/local/bin" >> $GITHUB_PATH

      - name: Set up Python ${{ matrix.python-version }}
        run: uv python install ${{ matrix.python-version }}

      - name: Build package
        run: uv build --no-sources

      - name: Verify build
        run: |
          uv run --with ./dist/mkdocs_live_wysiwyg_plugin-*.whl --no-project -- python -c "import mkdocs_live_wysiwyg_plugin; print('OK')"

  render:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ['3.10', '3.11', '3.12', '3.13']
    steps:
      - uses: actions/checkout@v4

      - name: Install uv and yq from .github/download-utilities.yml
        run: |
          YML_INSTALL_FILES_VERSION="v3.8"
          curl -fsSL -o download-utilities.sh "https://raw.githubusercontent.com/samrocketman/yml-install-files/${YML_INSTALL_FILES_VERSION}/download-utilities.sh"
          chmod +x download-utilities.sh
          ./download-utilities.sh .github/download-utilities.yml uv yq
          echo "/usr/local/bin" >> $GITHUB_PATH

      - name: Set up Python ${{ matrix.python-version }}
        run: uv python install ${{ matrix.python-version }}

      - name: Download techdocs-preview.sh
        run: |
          curl -fsSL -o techdocs-preview.sh \
            https://raw.githubusercontent.com/samrocketman/home/main/bin/techdocs-preview.sh
          chmod +x techdocs-preview.sh

      - name: Add plugin and build site
        run: |
          ./techdocs-preview.sh add_plugins --upgrade .
          ./techdocs-preview.sh build
